# 项目现状与参考
- 参考文件：`SCMTrainer_gamerules.md`（约165行）、`SCMTrainer1.2_suggestion.md`（约307行）——规则与改造建议已与当前实现高度对应。
- 平衡关键集中区（避免改动）：
  - `lib/constants.js`：赛事日程与难度（5–60）、晋级线（67–99）、难度归一与斜率（160–174）、增益上限与比率（190–210）、全局倍率开关（309–317）。
  - `lib/smartcar.js`：`PENALTY_LIBRARY`（6–12）、`GROUP_TRACKS`（14–244）、`GROUP_CONFIG`（246–303）、评估/计时/罚时/计分（460–516）、赛道构建（365–439）。
  - `lib/competitions.js::buildContestConfig`（1445–1604）、失误系统（1365–1426）。
  - `lib/contest-integration.js`：`getCompetitionCutoff/calculatePassLine`（929–987）。

# 优化目标
- 不触碰数值与参数结构，维持既有平衡与晋级线。
- 改善性能、稳定性、日志与可观察性、UI易用性，提升教练模拟体验。

# 低风险优化项（不改动平衡）
- UI/渲染稳定性与性能
  - 批量 DOM 更新与最小化重排：在 `render.js` 的多处集中刷新路径进行片段构建后一次性注入（如 223–245、584–599），减少卡顿。
  - 结果弹窗并发/重复防护强化：基于 `_shownContestResults/_shownMockResults`（`render.js` 1167–1169、1862–1869）增加退栈守卫与队列化。
- 比赛日志与诊断
  - 添加日志级别过滤与开关：在 `lib/competitions.js` 与 `lib/contest-integration.js` 的 `addLog/log` 调用处增加级别判断，默认仅警告级别以上；不影响分数计算。
- 资格/结局防护
  - 防御性编程：`render.js::getStudentQualificationStatus`（12–85）与 `contest-integration.js` 资格/结果路径（509–739、1030–1135）增加空集合/异常容错与友好提示，避免极端状态崩溃。
- 随机种子与复现
  - 赛季/赛事种子管理：参考 `test-seeded-random.html` 的既有实践，面向“今日挑战”或回放模式引入固定种子入口；不改变得分逻辑，仅提升复现性。
- 成绩明细与规则入口（仅展示）
  - 智能车成绩明细弹窗：在 `contest-ui.js`/`render.js` 增加“元素用时/罚时/分数”明细视图，数据来源于 `ContestSimulator.simulateSmartCarTick`（`lib/competitions.js` 303–454）与 `smartcar.js` 的计算；仅展示，不干预计算。
  - 帮助入口：在 `help.html` 增加指向 `SCMTrainer_*` 文档的入口，便于理解规则；不改动逻辑。

# 风险控制
- 明确不改动：`GROUP_TRACKS`、`PENALTY_LIBRARY`、`GROUP_CONFIG`、晋级线与难度归一、增益上限与比率、训练/压力计算模型。
- 开关设计：所有新增开关默认关闭或设为“保守级别”，不改变默认结果；日志仅影响可见性。
- 代码位置选择：仅在 UI、日志、守卫与种子入口层面变更，不深入数值计算核心。

# 验证方案
- 基线快照（种子固定）：
  - 选择若干种子，记录同一赛季下总分、晋级线、资格名单、奖励结果；优化前后对比应完全一致。
- 性能对比：
  - 统计渲染耗时与重排次数，确认批量更新降低卡顿。
- 稳定性：
  - 人工构造边缘状态（空队员、全部退队、极端压力），确认 UI 与结局不崩溃且提示合理。

# 实施步骤（按优先顺序）
1. 渲染批处理与弹窗并发防护
  - 修改 `render.js`：集中批量注入（223–245、584–599）与队列化结果弹窗（1167–1169、1862–1869）。
2. 日志级别与开关
  - 在 `lib/constants.js` 添加 `LOG_LEVEL` 与 `ENABLE_VERBOSE_LOG`（默认 `warn/false`），在 `lib/competitions.js` 与 `lib/contest-integration.js` 的日志入口做级别判断。
3. 成绩明细视图
  - 在 `contest-ui.js`/`render.js` 增加“元素明细”弹窗，复用 `simulateSmartCarTick` 过程中的元素级数据；只读展示。
4. 帮助入口
  - 在 `help.html` 增加指向两份 `SCMTrainer` 文档的链接与锚点。
5. 资格/结局防护
  - 在 `render.js::getStudentQualificationStatus`（12–85）与 `contest-integration.js` 资格/结局路径（509–739、1030–1135）增加空值与异常守卫，不改变逻辑分支的最终判定。

# 交付与回滚
- 所有改动以特性开关包裹，默认不改变行为；若发现异常，单点关闭即可回到原始表现。
- 基线测试通过后再默认开启“仅可见性”的改进（如帮助入口/成绩明细）。

# 备注
- 全部改动遵循参考文档意图，仅增强可读性与教练体验，不改动分值与平衡。